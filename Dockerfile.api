FROM node:18-alpine

# Enable pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

WORKDIR /app
ENV NODE_ENV=development

# IMPORTANT: fix pnpm binary resolution
RUN pnpm config set node-linker=hoisted

# Copy manifests
COPY api-gateway/package.json api-gateway/pnpm-lock.yaml ./

# Install deps (includes devDependencies)
RUN pnpm install --frozen-lockfile

# Copy source
COPY api-gateway ./

# Build
RUN pnpm exec tsc -p tsconfig.build.json

CMD ["node", "dist/main.js"]
